#    _       _      _ _
#   (_)_   _(_) ___(_) |_ _   _
#   | | | | | |/ __| | __| | | |
#   | | |_| | | (__| | |_| |_| |
#  _/ |\__,_|_|\___|_|\__|\__, |
# |__/                    |___/
#
# Copyright (C) 2023 @juicity <https://github.com/juicity>
#
# This is a open-source software, liscensed under the AGPL-3.0 License.
# See /License for more information.

name: PR Build (Preview)
run-name:  "#${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }} @${{ github.event.pull_request.head.ref }}:${{ github.event.pull_request.head.sha }}"

on:
  pull_request:
    types: [ opened, synchronize, reopened, ready_for_review ]
    paths:
      - "**/*.go"
      - "**/*.c"
      - "**/*.h"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/pr-build.yml"
      - ".github/workflows/seed-build.yml"

jobs:
  pre-actions:
    if: ${{ github.event.pull_request.draft == false }}
    uses: daeuniverse/ci-seed-jobs/.github/workflows/pre-actions-public.yml@master
    with:
      repository: ${{ github.repository }}
      ref: ${{ github.event.pull_request.head.sha }}
      fetch_depth: 0
      check_runs: '["build", "pr-build-passed"]'
      app_id: ${{ secrets.GH_APP_ID }}
      private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      bot_name: "juicity-bot"
    secrets: inherit

  build:
    needs: [pre-actions]
    if: ${{ github.event.pull_request.draft == false }}
    uses: juicity/juicity/.github/workflows/seed-build.yml@pr_check_run
    with:
      ref: ${{ github.event.pull_request.head.sha }}
      pr-number: ${{ github.event.pull_request.number }}
      build-type: pr-build
    secrets: inherit

  post-actions:
    needs: [build]
    if: always()
    uses: daeuniverse/ci-seed-jobs/.github/workflows/juicity-post-actions.yml@master
    with:
      check_run_id: "juicity-bot[bot]/pr-build-passed"
      check_run_conclusion: ${{ needs.build.result }}
      app_id: ${{ secrets.GH_APP_ID }}
      private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
    secrets: inherit
